# M9.8.23 BUGFIX: Purge/Delete Not Using Custom Server Path

**Issue:** Purge and delete operations were not respecting per-server custom data paths
**Status:** ✅ FIXED
**Date:** 2026-01-14
**Severity:** HIGH (data not being removed from correct location)
**References:** M9.8.23 (Per-Server Path Override at Creation)

---

## Problem Description

After implementing M9.8.23 (per-server path override), three endpoints were still using the agent's default `server_data_path` instead of checking for the server's custom path:

1. **Purge endpoint** - `DELETE /api/agents/:id/servers/:serverId/purge`
2. **Soft delete endpoint** - `DELETE /api/agents/:id/servers/:serverId`
3. **Start/recreate endpoint** - `POST /api/agents/:id/servers/:serverId/start`

**Impact:**
- Purge with `removeData=true` would attempt to delete data at **agent's default path** instead of **server's custom path**
- Data not removed from correct location
- User confusion (data still exists after purge)

**Example:**
```
Server created with custom path: /mnt/storage/myserver
Agent default path: /var/lib/zedops/servers

Purge attempts to remove: /var/lib/zedops/servers/myserver ❌ (wrong!)
Data actually at: /mnt/storage/myserver ✅ (correct)

Result: Data not removed, still exists on host
```

---

## Root Cause

All three endpoints were using `agent.server_data_path` directly instead of checking:
```typescript
dataPath: agent.server_data_path  // ❌ Always uses agent default
```

Should have been:
```typescript
const dataPath = server.server_data_path || agent.server_data_path;  // ✅ Check server first
dataPath: dataPath
```

Additionally, some endpoints weren't querying the `server_data_path` column from the database.

---

## Fix Applied

### 1. Start/Recreate Endpoint (Line 1370)

**Before:**
```typescript
// Call server.create on agent
const createResponse = await stub.fetch(`http://do/servers`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    serverId: server.id,
    name: server.name,
    registry: agent.steam_zomboid_registry,
    imageTag: server.image_tag,
    config: configWithRconPort,
    gamePort: server.game_port,
    udpPort: server.udp_port,
    rconPort: server.rcon_port,
    dataPath: agent.server_data_path,  // ❌ Always uses agent default
  }),
});
```

**After:**
```typescript
// Call server.create on agent
// M9.8.23: Use server's custom path if set, otherwise use agent default
const dataPath = server.server_data_path || agent.server_data_path;

const createResponse = await stub.fetch(`http://do/servers`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    serverId: server.id,
    name: server.name,
    registry: agent.steam_zomboid_registry,
    imageTag: server.image_tag,
    config: configWithRconPort,
    gamePort: server.game_port,
    udpPort: server.udp_port,
    rconPort: server.rcon_port,
    dataPath: dataPath,  // ✅ Uses server's custom path or agent default
  }),
});
```

---

### 2. Purge Endpoint (Lines 1764-1800)

**Before:**
```typescript
// Query didn't include server_data_path
const server = await c.env.DB.prepare(
  `SELECT id, container_id, name FROM servers WHERE id = ? AND agent_id = ?`
)
  .bind(serverId, agentId)
  .first();

// ...

// Always used agent default
const response = await stub.fetch(`http://do/servers/${serverId}`, {
  method: 'DELETE',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    containerId: server.container_id || '',
    serverName: server.name,
    removeVolumes: removeData,
    dataPath: agent.server_data_path as string,  // ❌ Always uses agent default
  }),
});
```

**After:**
```typescript
// M9.8.23: Include server_data_path to check for custom path override
const server = await c.env.DB.prepare(
  `SELECT id, container_id, name, server_data_path FROM servers WHERE id = ? AND agent_id = ?`
)
  .bind(serverId, agentId)
  .first();

// ...

// M9.8.23: Use server's custom path if set, otherwise use agent default
const dataPath = server.server_data_path || agent.server_data_path;

const response = await stub.fetch(`http://do/servers/${serverId}`, {
  method: 'DELETE',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    containerId: server.container_id || '',
    serverName: server.name,
    removeVolumes: removeData,
    dataPath: dataPath as string,  // ✅ Uses server's custom path or agent default
  }),
});
```

---

### 3. Soft Delete Endpoint (Lines 1648-1697)

**Before:**
```typescript
// Query didn't include server_data_path
const server = await c.env.DB.prepare(
  `SELECT id, container_id, status FROM servers WHERE id = ? AND agent_id = ?`
)
  .bind(serverId, agentId)
  .first();

// ...

// Always used agent default
await stub.fetch(`http://do/servers/${serverId}`, {
  method: 'DELETE',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    containerId: server.container_id,
    serverName: serverName?.name || '',
    removeVolumes: false,
    dataPath: agent.server_data_path as string,  // ❌ Always uses agent default
  }),
});
```

**After:**
```typescript
// M9.8.23: Include server_data_path for custom path support
const server = await c.env.DB.prepare(
  `SELECT id, container_id, status, name, server_data_path FROM servers WHERE id = ? AND agent_id = ?`
)
  .bind(serverId, agentId)
  .first();

// ...

// M9.8.23: Use server's custom path if set, otherwise use agent default
const dataPath = server.server_data_path || agent.server_data_path;

await stub.fetch(`http://do/servers/${serverId}`, {
  method: 'DELETE',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    containerId: server.container_id,
    serverName: server.name as string,
    removeVolumes: false,
    dataPath: dataPath as string,  // ✅ Uses server's custom path or agent default
  }),
});
```

---

## Changes Made

**File:** `manager/src/routes/agents.ts`

**Lines Modified:**
- Line 1370: Start/recreate - Add dataPath determination logic
- Line 1384: Start/recreate - Use determined dataPath
- Line 1648: Soft delete - Update query to include server_data_path
- Line 1686: Soft delete - Add dataPath determination logic
- Line 1697: Soft delete - Use determined dataPath
- Line 1764: Purge - Update query to include server_data_path
- Line 1788: Purge - Add dataPath determination logic
- Line 1800: Purge - Use determined dataPath

**Total Changes:** 3 endpoints fixed, ~15 lines of code

---

## Testing

### Verification Steps

1. **Create server with custom path:**
   ```
   Server name: test-custom
   Custom path: /tmp/custom-test
   ```

2. **Verify data created at custom path:**
   ```bash
   ls -la /tmp/custom-test/test-custom
   # Should see bin/ and data/ directories
   ```

3. **Purge with removeData=true:**
   ```
   DELETE /api/agents/:id/servers/:serverId/purge?removeData=true
   ```

4. **Verify data removed from custom path:**
   ```bash
   ls -la /tmp/custom-test/test-custom
   # Should be gone
   ```

5. **Verify agent's default path untouched:**
   ```bash
   ls -la /var/lib/zedops/servers
   # Should NOT have test-custom directory
   ```

---

## Status

- [x] Bug identified
- [x] Root cause found (3 endpoints)
- [x] Fix applied to all 3 endpoints
- [x] Code reviewed
- [x] Deployed to production
- [x] Manual testing performed
- [x] Verified purge removes data from custom path ✅

**User Verification:** "ok it works!" - Confirmed working 2026-01-14

**Deployment:**
- ✅ Deployed to Cloudflare Workers (5.74 sec)
- ✅ Version: `eaa08662-2276-4b18-9cf5-2f7917033f75`
- ✅ URL: https://zedops.mail-bcf.workers.dev
- ✅ Date: 2026-01-14

---

## Related Issues

- **M9.8.23:** Per-Server Path Override at Creation (parent feature)
- **M9.8.24:** Restore UI for Soft-Deleted Servers (future work)

---

**Priority:** HIGH - Fixes critical data removal bug
**Complexity:** LOW - Simple logic fix in 3 places
