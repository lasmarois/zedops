# M9.8.23: Per-Server Path Override at Creation - COMPLETE ✅

**Feature:** Allow per-server data path override when creating a new server
**Status:** ✅ DEPLOYED
**Date Completed:** 2026-01-14
**Deployment URL:** https://zedops.mail-bcf.workers.dev
**Version:** b4bd87de-9956-46b5-b85e-0d3b2e85a8e7
**References:** M9.8.21 (Agent Configuration - Configure Button), M9.8.22 (Configuration Tab Display)

---

## Overview

Enables users to override the agent's default data path when creating a server, providing flexibility for per-server storage configurations without affecting the agent's default settings.

**Key Behavior:**
- **Blank field** → Uses agent's default `server_data_path` (inherited)
- **Custom path** → Stores per-server override in database
- **NULL in DB** → Means "inherit from agent" (backward compatible)

---

## What Was Built

### Database Schema (Migration 0010)

**File:** `manager/migrations/0010_add_server_data_path.sql`

```sql
ALTER TABLE servers ADD COLUMN server_data_path TEXT DEFAULT NULL;
```

**Behavior:**
- `NULL` = inherit from agent (default, backward compatible)
- Non-NULL = custom path for this specific server

**Migration Applied:**
- ✅ Remote D1 database (1 query executed, 1 row written)

---

### Backend API (Manager)

**File:** `manager/src/routes/agents.ts` (POST /api/agents/:id/servers)

**Changes:**

1. **Path Validation** (lines 893-910)
   ```typescript
   if (body.server_data_path) {
     // Must be absolute path
     if (!body.server_data_path.startsWith('/')) {
       return c.json({ error: 'server_data_path must be absolute' }, 400);
     }
     // Cannot be root
     if (body.server_data_path === '/') {
       return c.json({ error: 'Cannot use root directory' }, 400);
     }
     // Cannot be system directories
     const forbiddenPaths = ['/etc', '/var', '/usr', ...];
     if (forbiddenPaths.some(p => body.server_data_path === p || body.server_data_path?.startsWith(p + '/'))) {
       return c.json({ error: 'Cannot use system directories' }, 400);
     }
   }
   ```

2. **Data Path Determination** (line ~1015)
   ```typescript
   const dataPath = body.server_data_path || agent.server_data_path;
   ```

3. **Database Storage** (lines 1024-1041)
   ```typescript
   INSERT INTO servers (..., server_data_path)
   VALUES (..., ?)
   .bind(..., body.server_data_path || null)
   ```

4. **Agent Message** (lines 1053-1069)
   ```typescript
   await stub.fetch(`http://do/servers`, {
     body: JSON.stringify({
       dataPath: dataPath, // Uses custom override or agent default
       ...
     }),
   });
   ```

**File:** `manager/src/types/Server.ts`

```typescript
export interface CreateServerRequest {
  name: string;
  imageTag: string;
  config: ServerConfig;
  gamePort?: number;
  udpPort?: number;
  rconPort?: number;
  server_data_path?: string; // M9.8.23: Optional per-server path override
}
```

---

### Frontend (UI)

**File:** `frontend/src/lib/api.ts`

```typescript
export interface CreateServerRequest {
  name: string;
  imageTag: string;
  config: ServerConfig;
  gamePort?: number;
  udpPort?: number;
  rconPort?: number;
  server_data_path?: string; // M9.8.23: Optional per-server data path override
}
```

**File:** `frontend/src/components/ServerForm.tsx`

**Changes:**

1. **Imports** (lines 6-9)
   ```typescript
   import { useQuery } from '@tanstack/react-query';
   import { fetchAgentConfig } from '../lib/api';
   ```

2. **State Management** (lines 59-60)
   ```typescript
   const [customDataPath, setCustomDataPath] = useState('');
   const [dataPathError, setDataPathError] = useState('');
   ```

3. **Fetch Agent Config** (lines 63-67)
   ```typescript
   const { data: agentConfig } = useQuery({
     queryKey: ['agentConfig', agentId],
     queryFn: () => fetchAgentConfig(agentId),
     enabled: !!agentId,
   });
   ```

4. **Validation Function** (lines 86-114)
   ```typescript
   const validateDataPath = (path: string): boolean => {
     if (!path.trim()) {
       setDataPathError('');
       return true; // Empty = valid (use agent default)
     }
     if (!path.startsWith('/')) {
       setDataPathError('Path must be absolute (start with /)');
       return false;
     }
     if (path === '/') {
       setDataPathError('Cannot use root directory');
       return false;
     }
     const forbiddenPaths = ['/etc', '/var', '/usr', ...];
     if (forbiddenPaths.some(p => path === p || path.startsWith(p + '/'))) {
       setDataPathError('Cannot use system directories');
       return false;
     }
     setDataPathError('');
     return true;
   };
   ```

5. **Submit Handler** (lines 159-161)
   ```typescript
   if (customDataPath.trim()) {
     request.server_data_path = customDataPath.trim();
   }
   ```

6. **Form Field** (lines 328-351)
   ```tsx
   <div className="space-y-2">
     <Label htmlFor="customDataPath">
       Server Data Path <span className="text-muted-foreground">(Optional)</span>
     </Label>
     <Input
       id="customDataPath"
       type="text"
       value={customDataPath}
       onChange={(e) => {
         setCustomDataPath(e.target.value);
         validateDataPath(e.target.value);
       }}
       placeholder={agentConfig?.server_data_path || 'Loading...'}
       disabled={isSubmitting}
       className={dataPathError ? 'border-destructive' : ''}
     />
     {dataPathError && (
       <p className="text-sm text-destructive">{dataPathError}</p>
     )}
     <p className="text-xs text-muted-foreground">
       Override the agent's default data path for this server only. Leave blank to use agent default.
     </p>
   </div>
   ```

---

## Features Implemented

### 1. Optional Per-Server Path Override
- Form field in server creation modal
- Shows agent's default as placeholder
- Leave blank = inherit from agent
- Custom path = override agent default

### 2. Real-Time Validation
- Client-side validation on input change
- Must be absolute path (starts with `/`)
- Cannot be root (`/`)
- Cannot be system directories
- Error highlighting with border-destructive

### 3. Smart Placeholder Display
- Fetches agent config via React Query
- Shows agent's `server_data_path` as placeholder
- Updates automatically when agent config changes
- Caching prevents duplicate requests

### 4. Backend Validation
- Same validation rules as frontend
- Prevents invalid paths from being stored
- Returns clear error messages
- Reuses validation logic from M9.8.21

### 5. Database Storage
- `NULL` = inherit from agent (default behavior)
- Non-NULL = custom path override
- Backward compatible (existing servers get NULL after migration)

---

## Technical Implementation

### Data Flow

**Creating Server with Default Path (Blank Field):**
```
User: [leaves field blank]
  ↓
Frontend: request.server_data_path = undefined
  ↓
Backend: dataPath = body.server_data_path || agent.server_data_path
         → Uses agent.server_data_path
  ↓
Database: server_data_path = NULL (inherits from agent)
  ↓
Agent: Creates server at agent.server_data_path
```

**Creating Server with Custom Path:**
```
User: [enters /mnt/storage/myserver]
  ↓
Frontend: Validates path (absolute, not root, not system dir)
         request.server_data_path = '/mnt/storage/myserver'
  ↓
Backend: Validates path again
         dataPath = body.server_data_path
  ↓
Database: server_data_path = '/mnt/storage/myserver' (custom override)
  ↓
Agent: Creates server at /mnt/storage/myserver
```

### Validation Rules

**Same as Agent Configuration (M9.8.21):**
- ✅ Absolute path (starts with `/`)
- ❌ Root directory (`/`)
- ❌ System directories (`/etc`, `/var`, `/usr`, `/bin`, `/sbin`, `/boot`, `/sys`, `/proc`, `/dev`)

**Validation Locations:**
- Client-side (ServerForm.tsx) - Real-time feedback
- Server-side (agents.ts) - Security enforcement

---

## User Experience

### User Flow

1. Navigate to Agent Detail page
2. Click "Create Server" button
3. Fill in server name, image tag, passwords, etc.
4. See "Server Data Path" field (optional)
   - Placeholder shows agent's default: `/var/lib/zedops/servers`
   - Helper text: "Override the agent's default data path for this server only. Leave blank to use agent default."
5. **Option A:** Leave blank → Server uses agent default
6. **Option B:** Enter custom path → Server uses custom path
   - Real-time validation shows errors
   - Red border if invalid
7. Submit form
8. Server created at specified location

### Benefits

- **Flexibility:** Per-server storage without changing agent config
- **Clarity:** Placeholder shows agent's default
- **Safety:** Validation prevents invalid paths
- **Simplicity:** Blank = default (no extra steps needed)
- **Backward Compatible:** Existing servers unaffected

---

## Testing

### Manual Testing Checklist

**Backend:**
- [ ] Create server without custom path (uses agent default)
- [ ] Create server with custom path (stores in database)
- [ ] Custom path validation rejects `/`
- [ ] Custom path validation rejects `/etc`
- [ ] Custom path validation rejects `not-absolute`
- [ ] NULL in database means "inherit from agent"
- [ ] Agent receives correct path in server.create message

**Frontend:**
- [ ] Form shows agent's default path as placeholder
- [ ] Can leave field blank (uses default)
- [ ] Can provide custom path
- [ ] Client-side validation shows errors in real-time
- [ ] Error border appears for invalid paths
- [ ] Server creation succeeds with both scenarios

**Integration:**
- [ ] Server created at custom path (verify on host)
- [ ] Server created at agent default (verify on host)
- [ ] Existing servers unaffected (backward compatible)

---

## Deployment

**Manager:**
- ✅ Frontend built (6.08s)
- ✅ Assets uploaded (310.18 KiB)
- ✅ Deployed to Cloudflare Workers (7.83s)
- ✅ Version: b4bd87de-9956-46b5-b85e-0d3b2e85a8e7

**Database:**
- ✅ Migration 0010 applied to remote D1 database

**Changes:**
- Backend: 2 files modified
  - `manager/migrations/0010_add_server_data_path.sql` (NEW)
  - `manager/src/routes/agents.ts` (~50 lines)
  - `manager/src/types/Server.ts` (1 line)
- Frontend: 2 files modified
  - `frontend/src/lib/api.ts` (1 line)
  - `frontend/src/components/ServerForm.tsx` (~80 lines)
- Manager: 1 file modified
  - `manager/src/index.ts` (asset hash update)

---

## Data Management

### Changing Agent Path

**Scenario:** Admin updates agent's `server_data_path` from `/var/lib/zedops/servers` to `/mnt/storage/servers`

**Impact:**
- Servers with `server_data_path = NULL`: Will use NEW agent path on next operation
- Servers with custom path: Unaffected (still use their custom path)

**Example:**
```
Before:
  Agent: /var/lib/zedops/servers
  Server A: NULL → uses /var/lib/zedops/servers
  Server B: /mnt/storage/server-b → uses /mnt/storage/server-b

After (agent path changed):
  Agent: /mnt/storage/servers
  Server A: NULL → uses /mnt/storage/servers (NEW!)
  Server B: /mnt/storage/server-b → uses /mnt/storage/server-b (unchanged)
```

### Backward Compatibility

- Existing servers (before migration): `server_data_path` column will be NULL
- NULL = inherit from agent (current behavior)
- No breaking changes
- Existing servers continue to work as before

---

## Future Work (Not in This Submilestone)

### M9.8.24: Storage Metrics Display
- Add storage metrics card to Configuration tab
- Show disk usage for data paths
- Visual progress bars

### M9.8.25: Edit Server Data Path
- Allow editing path after creation
- Requires data migration tool
- Show warning about moving data
- Complex feature (deferred)

### M9.8.26: Bulk Path Update
- Update multiple servers at once
- Useful when changing agent default
- Mass migration tool

---

## Success Criteria

- [x] Database schema supports per-server path (column exists)
- [x] Server creation API accepts optional server_data_path
- [x] Path validation works (client + server)
- [x] Form shows agent's default as placeholder
- [x] Can create server with custom path
- [x] Can create server with default path (blank field)
- [x] Agent receives correct path
- [x] Deployed to production
- [ ] Server created at correct location on host (requires manual verification)

---

## Time Spent

**Estimated:** 1-2 hours
**Actual:** ~2 hours (planning + implementation + deployment)

**Breakdown:**
- Planning & setup: 15 minutes
- Backend implementation: 30 minutes
- Frontend implementation: 45 minutes
- Build & deployment: 15 minutes
- Documentation: 15 minutes

---

## Related Work

- **M9.8.21:** Agent Configuration - Configure Button (completed)
- **M9.8.22:** Configuration Tab Display (completed)
- **M9.8.24:** Storage Metrics Display (future)
- **M9.8.25:** Edit Server Data Path (future, complex)

---

**Status:** ✅ COMPLETE AND DEPLOYED (including bugfix)
**User Impact:** HIGH (flexibility for per-server storage configurations)
**Complexity:** MEDIUM (migration + validation + frontend integration)

---

## Post-Deployment Updates

### Bugfix Applied: 2026-01-14

**Issue:** Purge/delete/recreate operations not using custom server paths

**Fix:** Updated 3 endpoints to check `server.server_data_path` before falling back to `agent.server_data_path`

**Affected Endpoints:**
- Purge: `DELETE /api/agents/:id/servers/:serverId/purge`
- Soft delete: `DELETE /api/agents/:id/servers/:serverId`
- Start/recreate: `POST /api/agents/:id/servers/:serverId/start`

**Result:** All operations now correctly use per-server custom paths ✅

**Version:** `eaa08662-2276-4b18-9cf5-2f7917033f75`

**User Testing:** "ok it works!" - Confirmed working

See `M9.8.23-BUGFIX-purge-custom-path.md` for full details.
